import{Leafer as t,State as e,UI as i,ImageManager as a,Rect as s,Box as n,Group as r,Platform as o,Creator as h}from"@leafer-ui/draw";export*from"@leafer-ui/draw";import{registerUI as d,Creator as l,PropertyEvent as c,Debug as g,DataHelper as u,canvasSizeAttrs as p,LayoutEvent as m,RenderEvent as _,Event as v,EventCreator as f,registerUIEvent as D,LeafList as y,BoundsHelper as E,PointHelper as P,Bounds as O,ResizeEvent as T,LeaferEvent as w,CanvasManager as R,Leaf as x,Matrix as C,Platform as b,tempBounds as L,LeaferCanvasBase as M}from"@leafer/core";function S(t,e,i,a){var s,n=arguments.length,r=n<3?e:null===a?a=Object.getOwnPropertyDescriptor(e,i):a;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)r=Reflect.decorate(t,e,i,a);else for(var o=t.length-1;o>=0;o--)(s=t[o])&&(r=(n<3?s(r):n>3?s(e,i,r):s(e,i))||r);return n>3&&r&&Object.defineProperty(e,i,r),r}"function"==typeof SuppressedError&&SuppressedError;let k=class extends t{get __tag(){return"App"}get isApp(){return!0}constructor(t,e){super(t,e)}init(t,e){if(super.init(t,e),t){const{ground:e,tree:i,sky:a,editor:s}=t;e&&(this.ground=this.addLeafer(e)),(i||s)&&(this.tree=this.addLeafer(i)),(a||s)&&(this.sky=this.addLeafer(a||{type:"draw",usePartRender:!1})),s&&this.sky.add(this.editor=l.editor(s))}}__setApp(){const{canvas:t}=this,{realCanvas:e,view:i}=this.config;e||i===this.canvas.view||!t.parentView?this.realCanvas=!0:t.unrealCanvas(),this.leafer=this,this.watcher.disable(),this.layouter.disable(),this.__eventIds.push(this.on_(c.CHANGE,this.__onPropertyChange,this))}start(){super.start(),this.children.forEach((t=>t.start()))}stop(){this.children.forEach((t=>t.stop())),super.stop()}unlockLayout(){super.unlockLayout(),this.children.forEach((t=>t.unlockLayout()))}lockLayout(){super.lockLayout(),this.children.forEach((t=>t.lockLayout()))}forceRender(t){this.children.forEach((e=>e.forceRender(t)))}addLeafer(e){const i=new t(e);return this.add(i),i}add(t,e){if(!t.view){if(this.realCanvas&&!this.canvas.bounds)return void setTimeout((()=>this.add(t,e)),10);t.init(this.__getChildConfig(t.userConfig),this)}super.add(t,e),void 0!==e&&(t.canvas.childIndex=e),this.__listenChildEvents(t)}__onPropertyChange(){g.showHitView&&this.children.forEach((t=>t.forceUpdate("surface")))}__onCreated(){this.created=this.children.every((t=>t.created))}__onReady(){this.children.every((t=>t.ready))&&super.__onReady()}__onViewReady(){this.children.every((t=>t.viewReady))&&super.__onViewReady()}__onChildRenderEnd(t){this.renderer.addBlock(t.renderBounds),this.viewReady&&this.renderer.update()}__render(t,e){if(t.context){const i=e.matrix;i&&t.setTransform(i.a,i.b,i.c,i.d,i.e,i.f),this.children.forEach((e=>t.copyWorld(e.canvas)))}}__onResize(t){this.children.forEach((e=>e.resize(t))),super.__onResize(t)}__checkUpdateLayout(){this.children.forEach((t=>t.__layout.update()))}__getChildConfig(t){let e=Object.assign({},this.config);return e.hittable=e.realCanvas=void 0,t&&u.assign(e,t),this.autoLayout&&u.copyAttrs(e,this,p),e.view=this.realCanvas?void 0:this.view,e.fill=void 0,e}__listenChildEvents(t){t.once(m.END,(()=>this.__onReady())),t.once(_.START,(()=>this.__onCreated())),t.once(_.END,(()=>this.__onViewReady())),this.realCanvas&&this.__eventIds.push(t.on_(_.END,this.__onChildRenderEnd,this))}};k=S([d()],k);const A={},H={isHoldSpaceKey:()=>H.isHold("Space"),isHold:t=>A[t],setDownCode(t){A[t]||(A[t]=!0)},setUpCode(t){A[t]=!1}},B={LEFT:1,RIGHT:2,MIDDLE:4,defaultLeft(t){t.buttons||(t.buttons=1)},left:t=>1===t.buttons,right:t=>2===t.buttons,middle:t=>4===t.buttons};class I extends v{get spaceKey(){return H.isHoldSpaceKey()}get left(){return B.left(this)}get right(){return B.right(this)}get middle(){return B.middle(this)}constructor(t){super(t.type),this.bubbles=!0,Object.assign(this,t)}getBoxPoint(t){return t||(t=this.current),t.getBoxPoint(this)}getInnerPoint(t){return t||(t=this.current),t.getInnerPoint(this)}getLocalPoint(t){return t||(t=this.current),t.getLocalPoint(this)}getPagePoint(){return this.current.getPagePoint(this)}getInner(t){return this.getInnerPoint(t)}getLocal(t){return this.getLocalPoint(t)}getPage(){return this.getPagePoint()}static changeName(t,e){f.changeName(t,e)}}let N=class extends I{};N.POINTER="pointer",N.BEFORE_DOWN="pointer.before_down",N.BEFORE_MOVE="pointer.before_move",N.BEFORE_UP="pointer.before_up",N.DOWN="pointer.down",N.MOVE="pointer.move",N.UP="pointer.up",N.OVER="pointer.over",N.OUT="pointer.out",N.ENTER="pointer.enter",N.LEAVE="pointer.leave",N.TAP="tap",N.DOUBLE_TAP="double_tap",N.CLICK="click",N.DOUBLE_CLICK="double_click",N.LONG_PRESS="long_press",N.LONG_TAP="long_tap",N.MENU="pointer.menu",N.MENU_TAP="pointer.menu_tap",N=S([D()],N);const W=N,F={};let z=class extends N{static setList(t){this.list=t instanceof y?t:new y(t)}static setData(t){this.data=t}static getValidMove(t,e,i){const{draggable:a,dragBounds:s,x:n,y:r}=t,o=t.getLocalPoint(i,null,!0);return o.x+=e.x-n,o.y+=e.y-r,s&&this.getMoveInDragBounds(t.__local,"parent"===s?t.parent.boxBounds:s,o,!0),"x"===a&&(o.y=0),"y"===a&&(o.x=0),o}static getMoveInDragBounds(t,e,i,a){const s=t.x+i.x,n=t.y+i.y,r=s+t.width,o=n+t.height,h=e.x+e.width,d=e.y+e.height;return a||(i=Object.assign({},i)),E.includes(t,e)?(s>e.x?i.x+=e.x-s:r<h&&(i.x+=h-r),n>e.y?i.y+=e.y-n:o<d&&(i.y+=d-o)):(s<e.x?i.x+=e.x-s:r>h&&(i.x+=h-r),n<e.y?i.y+=e.y-n:o>d&&(i.y+=d-o)),i}getPageMove(t){return this.assignMove(t),this.current.getPagePoint(F,null,!0)}getInnerMove(t,e){return t||(t=this.current),this.assignMove(e),t.getInnerPoint(F,null,!0)}getLocalMove(t,e){return t||(t=this.current),this.assignMove(e),t.getLocalPoint(F,null,!0)}getPageTotal(){return this.getPageMove(!0)}getInnerTotal(t){return this.getInnerMove(t,!0)}getLocalTotal(t){return this.getLocalMove(t,!0)}getPageBounds(){const t=this.getPageTotal(),e=this.getPagePoint(),i={};return E.set(i,e.x-t.x,e.y-t.y,t.x,t.y),E.unsign(i),i}assignMove(t){F.x=t?this.totalX:this.moveX,F.y=t?this.totalY:this.moveY}};z.BEFORE_DRAG="drag.before_drag",z.START="drag.start",z.DRAG="drag",z.END="drag.end",z.OVER="drag.over",z.OUT="drag.out",z.ENTER="drag.enter",z.LEAVE="drag.leave",z=S([D()],z);const V=z;let j=class extends N{static setList(t){z.setList(t)}static setData(t){z.setData(t)}};j.DROP="drop",j=S([D()],j);let K=class extends z{};K.BEFORE_MOVE="move.before_move",K.START="move.start",K.MOVE="move",K.END="move.end",K=S([D()],K);let U=class extends I{};U.BEFORE_ROTATE="rotate.before_rotate",U.START="rotate.start",U.ROTATE="rotate",U.END="rotate.end",U=S([D()],U);let X=class extends z{};X.SWIPE="swipe",X.LEFT="swipe.left",X.RIGHT="swipe.right",X.UP="swipe.up",X.DOWN="swipe.down",X=S([D()],X);let Y=class extends I{};Y.BEFORE_ZOOM="zoom.before_zoom",Y.START="zoom.start",Y.ZOOM="zoom",Y.END="zoom.end",Y=S([D()],Y);let G=class extends I{};function Z(t){t.isApp||t.__eventIds.push(t.on_(K.BEFORE_MOVE,(e=>{t.zoomLayer.move(t.getValidMove(e.moveX,e.moveY))})),t.on_(Y.BEFORE_ZOOM,(e=>{const{zoomLayer:i}=t,a=t.getValidScale(e.scale);1!==a&&(P.scaleOf(i,e,a),i.scale=i.__.scaleX*a)})))}G.DOWN="key.down",G.HOLD="key.hold",G.UP="key.up",G=S([D()],G);const q=g.get("LeaferTypeCreator"),J={list:{},register(t,e){Q[t]?q.repeat(t):Q[t]=e},run(t,e){const i=Q[t];i&&i(e)}},{list:Q,register:$}=J;$("design",Z),$("document",(function(t){Z(t);const{move:e,zoom:i}=t.config;e.scroll="limit",i.min=1})),$("block",(function(t){const{config:e}=t;(e.wheel||(e.wheel={})).preventDefault=!1,(e.touch||(e.touch={})).preventDefault="auto"}));const tt=t.prototype;tt.initType=function(t){J.run(t,this)},tt.getValidMove=function(t,e){const{scroll:i,disabled:a}=this.app.config.move;if(i&&(Math.abs(t)>Math.abs(e)?e=0:t=0,"limit"===i)){const{x:i,y:a,width:s,height:n}=new O(this.__world).addPoint(this.zoomLayer),r=i+s-this.width,o=a+n-this.height;i>=0&&r<=0?t=0:t>0?i+t>0&&(t=-i):t<0&&r+t<0&&(t=-r),a>=0&&o<=0?e=0:e>0?a+e>0&&(e=-a):e<0&&o+e<0&&(e=-o)}return{x:a?0:t,y:a?0:e}},tt.getValidScale=function(t){const{scaleX:e}=this.zoomLayer.__,{min:i,max:a,disabled:s}=this.app.config.zoom,n=Math.abs(e*t);return n<i?t=i/e:n>a&&(t=a/e),s?1:t};class et{get transforming(){return!!(this.moveData||this.zoomData||this.rotateData)}constructor(t){this.interaction=t}move(t){const{interaction:e}=this;if(t.moveType||(t.moveType="move"),!this.moveData){const{path:i}=e.selector.getByPoint(t,e.hitRadius);t.path=i,this.moveData=Object.assign(Object.assign({},t),{moveX:0,moveY:0}),e.cancelHover(),e.emit(K.START,this.moveData)}t.path=this.moveData.path,e.emit(K.BEFORE_MOVE,t),e.emit(K.MOVE,t),this.transformEndWait()}zoom(t){const{interaction:e}=this;if(!this.zoomData){const{path:i}=e.selector.getByPoint(t,e.hitRadius);t.path=i,this.zoomData=Object.assign(Object.assign({},t),{scale:1}),e.cancelHover(),e.emit(Y.START,this.zoomData)}t.path=this.zoomData.path,e.emit(Y.BEFORE_ZOOM,t),e.emit(Y.ZOOM,t),this.transformEndWait()}rotate(t){const{interaction:e}=this;if(!this.rotateData){const{path:i}=e.selector.getByPoint(t,e.hitRadius);t.path=i,this.rotateData=Object.assign(Object.assign({},t),{rotation:0}),e.cancelHover(),e.emit(U.START,this.rotateData)}t.path=this.rotateData.path,e.emit(U.BEFORE_ROTATE,t),e.emit(U.ROTATE,t),this.transformEndWait()}transformEndWait(){clearTimeout(this.transformTimer),this.transformTimer=setTimeout((()=>{this.transformEnd()}),this.interaction.config.pointer.transformTime)}transformEnd(){this.moveEnd(),this.zoomEnd(),this.rotateEnd()}moveEnd(){this.moveData&&(this.interaction.emit(K.END,this.moveData),this.moveData=null)}zoomEnd(){this.zoomData&&(this.interaction.emit(Y.END,this.zoomData),this.zoomData=null)}rotateEnd(){this.rotateData&&(this.interaction.emit(U.END,this.rotateData),this.rotateData=null)}destroy(){this.zoomData=this.moveData=this.rotateData=null}}const it={getMoveEventData:(t,e,i)=>Object.assign(Object.assign({},i),{x:t.x,y:t.y,moveX:e.x,moveY:e.y}),getRotateEventData:(t,e,i)=>Object.assign(Object.assign({},i),{x:t.x,y:t.y,rotation:e}),getZoomEventData:(t,e,i)=>Object.assign(Object.assign({},i),{x:t.x,y:t.y,scale:e}),getDragEventData:(t,e,i)=>Object.assign(Object.assign({},i),{x:i.x,y:i.y,moveX:i.x-e.x,moveY:i.y-e.y,totalX:i.x-t.x,totalY:i.y-t.y}),getDropEventData:(t,e,i)=>Object.assign(Object.assign({},t),{list:e,data:i}),getSwipeDirection:t=>t<-45&&t>-135?X.UP:t>45&&t<135?X.DOWN:t<=45&&t>=-45?X.RIGHT:X.LEFT,getSwipeEventData:(t,e,i)=>Object.assign(Object.assign({},i),{moveX:e.moveX,moveY:e.moveY,totalX:i.x-t.x,totalY:i.y-t.y,type:at.getSwipeDirection(P.getAngle(t,i))}),getBase(t){const e=1===t.button?4:t.button;return{altKey:t.altKey,ctrlKey:t.ctrlKey,shiftKey:t.shiftKey,metaKey:t.metaKey,buttons:void 0===t.buttons?1:0===t.buttons?e:t.buttons,origin:t}},pathHasEventType(t,e){const{list:i}=t;for(let t=0,a=i.length;t<a;t++)if(i[t].hasEvent(e))return!0;return!1},filterPathByEventType(t,e){const i=new y,{list:a}=t;for(let t=0,s=a.length;t<s;t++)a[t].hasEvent(e)&&i.add(a[t]);return i},pathCanDrag:t=>t&&t.list.some((t=>t.draggable||t.editable||!t.isLeafer&&t.hasEvent(z.DRAG))),pathHasOutside:t=>t&&t.list.some((t=>t.isOutside))},at=it,st=new y,{getDragEventData:nt,getDropEventData:rt,getSwipeEventData:ot}=it;class ht{constructor(t){this.interaction=t}setDragData(t){this.animateWait&&this.dragEndReal(),this.downData=this.interaction.downData,this.dragData=nt(t,t,t),this.canAnimate=this.canDragOut=!0}getList(t,e){const{proxy:i}=this.interaction.selector,a=i&&i.list.length,s=z.list||this.draggableList||st;return this.dragging&&(a?t?st:new y(e?[...i.list,...i.dragHoverExclude]:i.list):s)}checkDrag(t,e){const{interaction:i}=this;if(this.moving&&t.buttons<1)return this.canAnimate=!1,void i.pointerCancel();!this.moving&&e&&(this.moving=i.canMove(this.downData)||i.isHoldRightKey||i.isMobileDragEmpty)&&(this.dragData.moveType="drag",i.emit(K.START,this.dragData)),this.moving||this.dragStart(t,e),this.drag(t)}dragStart(t,e){this.dragging||(this.dragging=e&&B.left(t),this.dragging&&(this.interaction.emit(z.START,this.dragData),this.getDraggableList(this.dragData.path),this.setDragStartPoints(this.realDraggableList=this.getList(!0))))}setDragStartPoints(t){this.dragStartPoints={},t.forEach((t=>this.dragStartPoints[t.innerId]={x:t.x,y:t.y}))}getDraggableList(t){let e;for(let i=0,a=t.length;i<a;i++)if(e=t.list[i],(e.draggable||e.editable)&&e.hitSelf&&!e.locked){this.draggableList=new y(e);break}}drag(t){const{interaction:e,dragData:i,downData:a}=this,{path:s,throughPath:n}=a;this.dragData=nt(a,i,t),n&&(this.dragData.throughPath=n),this.dragData.path=s,this.moving?(this.dragData.moveType="drag",e.emit(K.BEFORE_MOVE,this.dragData),e.emit(K.MOVE,this.dragData)):this.dragging&&(this.dragReal(),e.emit(z.BEFORE_DRAG,this.dragData),e.emit(z.DRAG,this.dragData))}dragReal(){const{running:t}=this.interaction,e=this.realDraggableList;if(e.length&&t){const{totalX:t,totalY:i}=this.dragData;e.forEach((e=>e.draggable&&e.move(z.getValidMove(e,this.dragStartPoints[e.innerId],{x:t,y:i}))))}}dragOverOrOut(t){const{interaction:e}=this,{dragOverPath:i}=this,{path:a}=t;this.dragOverPath=a,i?a.indexAt(0)!==i.indexAt(0)&&(e.emit(z.OUT,t,i),e.emit(z.OVER,t,a)):e.emit(z.OVER,t,a)}dragEnterOrLeave(t){const{interaction:e}=this,{dragEnterPath:i}=this,{path:a}=t;e.emit(z.LEAVE,t,i,a),e.emit(z.ENTER,t,a,i),this.dragEnterPath=a}dragEnd(t,e){if(!this.dragging&&!this.moving)return;const{moveX:i,moveY:a}=this.dragData;this.interaction.config.move.dragAnimate&&this.canAnimate&&this.moving&&(Math.abs(i)>1||Math.abs(a)>1)?(t=Object.assign({},t),e=.9*(e||("touch"===t.pointerType?2:1)),P.move(t,i*e,a*e),this.drag(t),this.animate((()=>{this.dragEnd(t,1)}))):this.dragEndReal(t)}dragEndReal(t){const{interaction:e,downData:i,dragData:a}=this;t||(t=a);const{path:s,throughPath:n}=i,r=nt(i,t,t);if(n&&(r.throughPath=n),r.path=s,this.moving&&(this.moving=!1,r.moveType="drag",e.emit(K.END,r)),this.dragging){const s=this.getList();this.dragging=!1,e.emit(z.END,r),this.swipe(t,i,a,r),this.drop(t,s,this.dragEnterPath)}this.autoMoveCancel(),this.dragReset(),this.animate(null,"off")}animate(t,e){const i=t||this.animateWait;i&&this.interaction.target.nextRender(i,null,e),this.animateWait=t}swipe(t,e,i,a){const{interaction:s}=this;if(P.getDistance(e,t)>s.config.pointer.swipeDistance){const t=ot(e,i,a);this.interaction.emit(t.type,t)}}drop(t,e,i){const a=rt(t,e,z.data);a.path=i,this.interaction.emit(j.DROP,a),this.interaction.emit(z.LEAVE,t,i)}dragReset(){z.list=z.data=this.draggableList=this.dragData=this.downData=this.dragOverPath=this.dragEnterPath=null}checkDragOut(t){const{interaction:e}=this;this.autoMoveCancel(),this.dragging&&!e.shrinkCanvasBounds.hitPoint(t)&&this.autoMoveOnDragOut(t)}autoMoveOnDragOut(t){const{interaction:e,downData:i,canDragOut:a}=this,{autoDistance:s,dragOut:n}=e.config.move;if(!n||!a||!s)return;const r=e.shrinkCanvasBounds,{x:o,y:h}=r,d=E.maxX(r),l=E.maxY(r),c=t.x<o?s:d<t.x?-s:0,g=t.y<h?s:l<t.y?-s:0;let u=0,p=0;this.autoMoveTimer=setInterval((()=>{u+=c,p+=g,P.move(i,c,g),P.move(this.dragData,c,g),e.move(Object.assign(Object.assign({},t),{moveX:c,moveY:g,totalX:u,totalY:p,moveType:"drag"})),e.pointerMoveReal(t)}),10)}autoMoveCancel(){this.autoMoveTimer&&(clearInterval(this.autoMoveTimer),this.autoMoveTimer=0)}destroy(){this.dragReset()}}const dt=g.get("emit");const lt=["move","zoom","rotate","key"];function ct(t,e,i,a,s){if(lt.some((t=>e.startsWith(t)))&&t.__.hitChildren&&!ut(t,s)){let n;for(let r=0,o=t.children.length;r<o;r++)n=t.children[r],!i.path.has(n)&&n.__.hittable&&gt(n,e,i,a,s)}}function gt(t,i,a,s,n){if(t.destroyed)return!1;if(t.__.hitSelf&&!ut(t,n)&&(e.updateEventStyle&&!s&&e.updateEventStyle(t,i),t.hasEvent(i,s))){a.phase=s?1:t===a.target?2:3;const e=f.get(i,a);if(t.emitEvent(e,s),e.isStop)return!0}return!1}function ut(t,e){return e&&e.has(t)}const pt={getData(t){const e=t[0],i=t[1],a=P.getCenter(e.from,i.from),s=P.getCenter(e.to,i.to),n={x:s.x-a.x,y:s.y-a.y},r=P.getDistance(e.from,i.from);return{move:n,scale:P.getDistance(e.to,i.to)/r,angle:P.getRotation(e.from,i.from,e.to,i.to),center:s}}},mt={wheel:{zoomSpeed:.5,moveSpeed:.5,rotateSpeed:.5,delta:{x:20,y:8},preventDefault:!0},pointer:{hitRadius:5,tapTime:120,longPressTime:800,transformTime:500,hover:!0,dragHover:!0,dragDistance:2,swipeDistance:20,preventDefaultMenu:!0},touch:{preventDefault:!0},multiTouch:{},cursor:!0,keyEvent:!0},{pathHasEventType:_t,getMoveEventData:vt,getZoomEventData:ft,getRotateEventData:Dt,pathCanDrag:yt,pathHasOutside:Et}=it;class Pt{get dragging(){return this.dragger.dragging}get transforming(){return this.transformer.transforming}get moveMode(){return!0===this.m.drag||this.isHoldSpaceKey||this.isHoldMiddleKey||this.isHoldRightKey&&this.dragger.moving||this.isDragEmpty}get canHover(){return this.p.hover&&!this.config.mobile}get isDragEmpty(){return this.m.dragEmpty&&this.isRootPath(this.hoverData)&&(!this.downData||this.isRootPath(this.downData))}get isMobileDragEmpty(){return this.m.dragEmpty&&!this.canHover&&this.downData&&this.isTreePath(this.downData)}get isHoldMiddleKey(){return this.m.holdMiddleKey&&this.downData&&B.middle(this.downData)}get isHoldRightKey(){return this.m.holdRightKey&&this.downData&&B.right(this.downData)}get isHoldSpaceKey(){return this.m.holdSpaceKey&&H.isHoldSpaceKey()}get m(){return this.config.move}get p(){return this.config.pointer}get hitRadius(){return this.p.hitRadius}constructor(t,e,i,a){this.config=u.clone(mt),this.tapCount=0,this.downKeyMap={},this.target=t,this.canvas=e,this.selector=i,this.defaultPath=new y(t),this.transformer=new et(this),this.dragger=new ht(this),a&&(this.config=u.default(a,this.config)),this.__listenEvents()}start(){this.running=!0}stop(){this.running=!1}receive(t){}pointerDown(t,e){t||(t=this.hoverData),t&&(B.defaultLeft(t),this.updateDownData(t),this.checkPath(t,e),this.downTime=Date.now(),this.emit(N.BEFORE_DOWN,t),this.emit(N.DOWN,t),B.left(t)&&(this.tapWait(),this.longPressWait(t)),this.waitRightTap=B.right(t),this.dragger.setDragData(t),this.isHoldRightKey||this.updateCursor(t))}pointerMove(t){if(t||(t=this.hoverData),!t)return;const{downData:e}=this;e&&B.defaultLeft(t);(this.canvas.bounds.hitPoint(t)||e)&&(this.pointerMoveReal(t),e&&this.dragger.checkDragOut(t))}pointerMoveReal(t){const{dragHover:e,dragDistance:i}=this.p;if(this.emit(N.BEFORE_MOVE,t,this.defaultPath),this.downData){const e=P.getDistance(this.downData,t)>i;e&&(this.waitTap&&this.pointerWaitCancel(),this.waitRightTap=!1),this.dragger.checkDrag(t,e)}this.dragger.moving||(this.updateHoverData(t),this.checkPath(t),this.emit(N.MOVE,t),this.dragging&&!e||this.pointerHover(t),this.dragger.dragging&&(this.dragger.dragOverOrOut(t),this.dragger.dragEnterOrLeave(t))),this.updateCursor(this.downData||t)}pointerUp(t){const{downData:e}=this;if(t||(t=e),!e)return;B.defaultLeft(t),t.multiTouch=e.multiTouch,this.findPath(t);const i=Object.assign(Object.assign({},t),{path:t.path.clone()});t.path.addList(e.path.list),this.checkPath(t),this.downData=null,this.emit(N.BEFORE_UP,t),this.emit(N.UP,t),this.touchLeave(t),t.isCancel||(this.tap(t),this.menuTap(t)),this.dragger.dragEnd(t),this.updateCursor(i)}pointerCancel(){const t=Object.assign({},this.dragger.dragData);t.isCancel=!0,this.pointerUp(t)}multiTouch(t,e){if(this.config.multiTouch.disabled)return;const{move:i,angle:a,scale:s,center:n}=pt.getData(e);this.rotate(Dt(n,a,t)),this.zoom(ft(n,s,t)),this.move(vt(n,i,t))}menu(t){this.findPath(t),this.emit(N.MENU,t),this.waitMenuTap=!0,!this.downData&&this.waitRightTap&&this.menuTap(t)}menuTap(t){this.waitRightTap&&this.waitMenuTap&&(this.emit(N.MENU_TAP,t),this.waitRightTap=this.waitMenuTap=!1)}move(t){this.transformer.move(t)}zoom(t){this.transformer.zoom(t)}rotate(t){this.transformer.rotate(t)}transformEnd(){this.transformer.transformEnd()}keyDown(t){if(!this.config.keyEvent)return;const{code:e}=t;this.downKeyMap[e]||(this.downKeyMap[e]=!0,H.setDownCode(e),this.emit(G.HOLD,t,this.defaultPath),this.moveMode&&(this.cancelHover(),this.updateCursor())),this.emit(G.DOWN,t,this.defaultPath)}keyUp(t){if(!this.config.keyEvent)return;const{code:e}=t;this.downKeyMap[e]=!1,H.setUpCode(e),this.emit(G.UP,t,this.defaultPath),"grab"===this.cursor&&this.updateCursor()}pointerHover(t){this.canHover&&(this.pointerOverOrOut(t),this.pointerEnterOrLeave(t))}pointerOverOrOut(t){const{path:e}=t,{overPath:i}=this;this.overPath=e,i?e.indexAt(0)!==i.indexAt(0)&&(this.emit(N.OUT,t,i),this.emit(N.OVER,t,e)):this.emit(N.OVER,t,e)}pointerEnterOrLeave(t){let{path:e}=t;this.downData&&!this.moveMode&&(e=e.clone(),this.downData.path.forEach((t=>e.add(t))));const{enterPath:i}=this;this.enterPath=e,this.emit(N.LEAVE,t,i,e),this.emit(N.ENTER,t,e,i)}touchLeave(t){"touch"===t.pointerType&&this.enterPath&&(this.emit(N.LEAVE,t),this.dragger.dragging&&this.emit(j.LEAVE,t))}tap(t){const{pointer:e}=this.config,i=this.longTap(t);if(!e.tapMore&&i)return;if(!this.waitTap)return;e.tapMore&&this.emitTap(t);const a=Date.now()-this.downTime,s=[N.DOUBLE_TAP,N.DOUBLE_CLICK].some((e=>_t(t.path,e)));a<e.tapTime+50&&s?(this.tapCount++,2===this.tapCount?(this.tapWaitCancel(),this.emitDoubleTap(t)):(clearTimeout(this.tapTimer),this.tapTimer=setTimeout((()=>{e.tapMore||(this.tapWaitCancel(),this.emitTap(t))}),e.tapTime))):e.tapMore||(this.tapWaitCancel(),this.emitTap(t))}findPath(t,e){const{hitRadius:i,through:a}=this.p,{bottomList:s}=this,n=this.selector.getByPoint(t,i,Object.assign({bottomList:s,name:t.type},e||{through:a}));return n.throughPath&&(t.throughPath=n.throughPath),t.path=n.path,n.path}isRootPath(t){return t&&t.path.list[0].isLeafer}isTreePath(t){const e=this.target.app;return!(!e||!e.isApp)&&(e.editor&&!t.path.has(e.editor)&&t.path.has(e.tree)&&!t.target.syncEventer)}checkPath(t,e){(e||this.moveMode&&!Et(t.path))&&(t.path=this.defaultPath)}canMove(t){return t&&(this.moveMode||"auto"===this.m.drag&&!yt(t.path))&&!Et(t.path)}isDrag(t){return this.dragger.getList().has(t)}isPress(t){return this.downData&&this.downData.path.has(t)}isHover(t){return this.enterPath&&this.enterPath.has(t)}isFocus(t){return this.focusData===t}cancelHover(){const{hoverData:t}=this;t&&(t.path=this.defaultPath,this.pointerHover(t))}updateDownData(t,e,i){const{downData:a}=this;!t&&a&&(t=a),t&&(this.findPath(t,e),i&&a&&t.path.addList(a.path.list),this.downData=t)}updateHoverData(t){t||(t=this.hoverData),t&&(this.findPath(t,{exclude:this.dragger.getList(!1,!0),name:N.MOVE}),this.hoverData=t)}updateCursor(t){if(!this.config.cursor||!this.canHover)return;if(t||(this.updateHoverData(),t=this.downData||this.hoverData),this.dragger.moving)return this.setCursor("grabbing");if(this.canMove(t))return this.setCursor(this.downData?"grabbing":"grab");if(!t)return;let e,i;const{path:a}=t;for(let t=0,s=a.length;t<s&&(e=a.list[t],i=e.syncEventer&&e.syncEventer.cursor||e.cursor,!i);t++);this.setCursor(i)}setCursor(t){this.cursor=t}getLocal(t,e){const i=this.canvas.getClientBounds(e);return{x:t.clientX-i.x,y:t.clientY-i.y}}emitTap(t){this.emit(N.TAP,t),this.emit(N.CLICK,t)}emitDoubleTap(t){this.emit(N.DOUBLE_TAP,t),this.emit(N.DOUBLE_CLICK,t)}pointerWaitCancel(){this.tapWaitCancel(),this.longPressWaitCancel()}tapWait(){clearTimeout(this.tapTimer),this.waitTap=!0}tapWaitCancel(){clearTimeout(this.tapTimer),this.waitTap=!1,this.tapCount=0}longPressWait(t){clearTimeout(this.longPressTimer),this.longPressTimer=setTimeout((()=>{this.longPressed=!0,this.emit(N.LONG_PRESS,t)}),this.p.longPressTime)}longTap(t){let e;return this.longPressed&&(this.emit(N.LONG_TAP,t),(_t(t.path,N.LONG_TAP)||_t(t.path,N.LONG_PRESS))&&(e=!0)),this.longPressWaitCancel(),e}longPressWaitCancel(){clearTimeout(this.longPressTimer),this.longPressed=!1}__onResize(){this.shrinkCanvasBounds=new O(this.canvas.bounds),this.shrinkCanvasBounds.spread(-2)}__listenEvents(){const{target:t}=this;this.__eventIds=[t.on_(T.RESIZE,this.__onResize,this)],t.once(w.READY,(()=>this.__onResize()))}__removeListenEvents(){this.target.off_(this.__eventIds),this.__eventIds.length=0}emit(t,e,i,a){this.running&&function(t,e,i,a){if(!i&&!e.path)return;let s;e.type=t,i?e=Object.assign(Object.assign({},e),{path:i}):i=e.path,e.target=i.indexAt(0);try{for(let n=i.length-1;n>-1;n--){if(s=i.list[n],gt(s,t,e,!0,a))return;s.isApp&&ct(s,t,e,!0,a)}for(let n=0,r=i.length;n<r;n++)if(s=i.list[n],s.isApp&&ct(s,t,e,!1,a),gt(s,t,e,!1,a))return}catch(t){dt.error(t)}}(t,e,i,a)}destroy(){this.__eventIds.length&&(this.stop(),this.__removeListenEvents(),this.dragger.destroy(),this.transformer.destroy(),this.downData=this.overPath=this.enterPath=null)}}class Ot{static set(t,e){this.custom[t]=e}static get(t){return this.custom[t]}}Ot.custom={};class Tt extends R{constructor(){super(...arguments),this.maxTotal=1e3,this.pathList=new y,this.pixelList=new y}getPixelType(t,e){return this.__autoClear(),this.pixelList.add(t),l.hitCanvas(e)}getPathType(t){return this.__autoClear(),this.pathList.add(t),l.hitCanvas()}clearImageType(){this.__clearLeafList(this.pixelList)}clearPathType(){this.__clearLeafList(this.pathList)}__clearLeafList(t){t.length&&(t.forEach((t=>{t.__hitCanvas&&(t.__hitCanvas.destroy(),t.__hitCanvas=null)})),t.reset())}__autoClear(){this.pathList.length+this.pixelList.length>this.maxTotal&&this.clear()}clear(){this.clearPathType(),this.clearImageType()}}const{toInnerRadiusPointOf:wt,copy:Rt,setRadius:xt}=P,Ct={},bt=x.prototype;bt.__hitWorld=function(t){if(!this.__.hitSelf)return!1;this.__.hitRadius&&(Rt(Ct,t),xt(t=Ct,this.__.hitRadius)),wt(t,this.__world,Ct);const{width:e,height:i}=this.__world,a=e<10&&i<10;if(this.__.hitBox||a){if(E.hitRadiusPoint(this.__layout.boxBounds,Ct))return!0;if(a)return!1}return!this.__layout.hitCanvasChanged&&this.__hitCanvas||(this.__updateHitCanvas(),this.__layout.boundsChanged||(this.__layout.hitCanvasChanged=!1)),this.__hit(Ct)},bt.__hitFill=function(t){var e;return null===(e=this.__hitCanvas)||void 0===e?void 0:e.hitFill(t,this.__.windingRule)},bt.__hitStroke=function(t,e){var i;return null===(i=this.__hitCanvas)||void 0===i?void 0:i.hitStroke(t,e)},bt.__hitPixel=function(t){var e;return null===(e=this.__hitCanvas)||void 0===e?void 0:e.hitPixel(t,this.__layout.renderBounds,this.__hitCanvas.hitScale)},bt.__drawHitPath=function(t){t&&this.__drawRenderPath(t)};const Lt=new C,Mt=i.prototype;Mt.__updateHitCanvas=function(){const t=this.__,{hitCanvasManager:e}=this.leafer,i=(t.__pixelFill||t.__isCanvas)&&"pixel"===t.hitFill,s=t.__pixelStroke&&"pixel"===t.hitStroke,n=i||s;this.__hitCanvas||(this.__hitCanvas=n?e.getPixelType(this,{contextSettings:{willReadFrequently:!0}}):e.getPathType(this));const r=this.__hitCanvas;if(n){const{renderBounds:e}=this.__layout,n=b.image.hitCanvasSize,o=r.hitScale=L.set(0,0,n,n).getFitMatrix(e).a,{x:h,y:d,width:l,height:c}=L.set(e).scale(o);r.resize({width:l,height:c,pixelRatio:1}),r.clear(),a.patternLocked=!0,this.__renderShape(r,{matrix:Lt.setWith(this.__world).scaleWith(1/o).invertWith().translate(-h,-d)},!i,!s),a.patternLocked=!1,r.resetTransform(),t.__isHitPixel=!0}else t.__isHitPixel&&(t.__isHitPixel=!1);this.__drawHitPath(r),r.setStrokeOptions(t)},Mt.__hit=function(t){"miniapp"===b.name&&this.__drawHitPath(this.__hitCanvas);const e=this.__;if(e.__isHitPixel&&this.__hitPixel(t))return!0;const{hitFill:i}=e,a=(e.fill||e.__isCanvas)&&("path"===i||"pixel"===i&&!(e.__pixelFill||e.__isCanvas))||"all"===i;if(a&&this.__hitFill(t))return!0;const{hitStroke:s,__strokeWidth:n}=e,r=e.stroke&&("path"===s||"pixel"===s&&!e.__pixelStroke)||"all"===s;if(!a&&!r)return!1;const o=2*t.radiusX;let h=o;if(r)switch(e.strokeAlign){case"inside":if(h+=2*n,!a&&this.__hitFill(t)&&this.__hitStroke(t,h))return!0;h=o;break;case"center":h+=n;break;case"outside":if(h+=2*n,!a){if(!this.__hitFill(t)&&this.__hitStroke(t,h))return!0;h=o}}return!!h&&this.__hitStroke(t,h)};const St=i.prototype,kt=s.prototype,At=n.prototype;kt.__updateHitCanvas=At.__updateHitCanvas=function(){this.stroke||this.cornerRadius||(this.fill||this.__.__isCanvas)&&"pixel"===this.hitFill||"all"===this.hitStroke?St.__updateHitCanvas.call(this):this.__hitCanvas&&(this.__hitCanvas=null)},kt.__hitFill=At.__hitFill=function(t){return this.__hitCanvas?St.__hitFill.call(this,t):E.hitRadiusPoint(this.__layout.boxBounds,t)};const Ht=i.prototype,Bt=r.prototype;function It(t){return t.leafer?t.leafer.selector:o.selector||(o.selector=h.selector())}Ht.find=function(t,e){return It(this).getBy(t,this,!1,e)},Ht.findOne=function(t,e){return It(this).getBy(t,this,!0,e)},Bt.pick=function(t,e){return this.__layout.update(),e||(e={}),It(this).getByPoint(t,e.hitRadius||0,Object.assign(Object.assign({},e),{target:this}))};const Nt=M.prototype;Nt.hitFill=function(t,e){return e?this.context.isPointInPath(t.x,t.y,e):this.context.isPointInPath(t.x,t.y)},Nt.hitStroke=function(t,e){return this.strokeWidth=e,this.context.isPointInStroke(t.x,t.y)},Nt.hitPixel=function(t,e,i=1){let{x:a,y:s,radiusX:n,radiusY:r}=t;e&&(a-=e.x,s-=e.y),L.set(a-n,s-r,2*n,2*r).scale(i).ceil();const{data:o}=this.context.getImageData(L.x,L.y,L.width||1,L.height||1);for(let t=0,e=o.length;t<e;t+=4)if(o[t+3]>0)return!0;return o[3]>0};export{k as App,Ot as Cursor,z as DragEvent,j as DropEvent,Tt as HitCanvasManager,Pt as InteractionBase,it as InteractionHelper,G as KeyEvent,H as Keyboard,J as LeaferTypeCreator,K as MoveEvent,pt as MultiTouchHelper,V as MyDragEvent,W as MyPointerEvent,B as PointerButton,N as PointerEvent,U as RotateEvent,X as SwipeEvent,I as UIEvent,Y as ZoomEvent,Z as addInteractionWindow};
