import{decorateLeafAttr as t,attr as e,State as n}from"@leafer-ui/draw";import{MathHelper as s,State as i,isNull as o,PointerEvent as l,UI as r,dataType as a}from"@leafer-ui/core";function c(s,i){return t(s,(t=>e({set(e){this.__setAttr(t,e),this.waitLeafer((()=>i?n.setStyleName(this,i,e):n.set(this,e)))}})))}function u(n){return t(n,(t=>e({set(e){this.__setAttr(t,e),this.__layout.stateStyleChanged=!0}})))}function f(t,e){if(e&&!0!==e)return e;if(!t.button){let{parent:e}=t;for(let t=0;t<2;t++)if(e){if(e.button)return e;e=e.parent}}return null}function S(t,e){"object"!=typeof e&&(e=void 0),h(t,e,"in")}function y(t,e){const{normalStyle:n}=t;"object"!=typeof e&&(e=void 0),n&&(e||(e=n),h(t,e,"out"))}const d={};function h(t,e,n){const{normalStyle:l}=t;e||(e=d),e.scale&&(s.assignScale(e,e.scale),delete e.scale),e!==d&&i.canAnimate||(n=null);let r=!!n&&function(t,e,n){let s="in"===t?"transition":"transitionOut";"out"===t&&o(n[s])&&o(e[s])&&(s="transition");return o(e[s])?n[s]:e[s]}(n,e,t);const a=r?function(t,e){const n=p(e,t),s=t.animate();s&&p(n,t,s.fromStyle);return n}(t,e):void 0;t.killAnimate("transition"),l&&t.set(l,!0);const c=m(t);if(c){const{animation:s}=c;if(s){const i=t.animate(s,void 0,"animation",!0);Object.assign(c,i.endingStyle),"in"!==n||e.animation!==s?i.kill():r=!1,delete c.animation}t.normalStyle=b(c,t),t.set(c,!0)}else t.normalStyle=void 0;if(r){const e=b(a,t);t.set(a,!0),t.animate([a,e],r,"transition",!0)}t.__layout.stateStyleChanged=!1}function m(t){let e;const n={},{state:s}=t,o=f(t),l=s&&t.states[s];l&&i.isState(s,t,o)&&(e=v(n,l));const r=n.selectedStyle||t.selectedStyle;if(r&&i.isSelected(t,o)&&(e=v(n,r)),i.isDisabled(t,o)){const s=n.disabledStyle||t.disabledStyle;s&&(e=v(n,s))}else{const s=n.focusStyle||t.focusStyle;s&&i.isFocus(t,o)&&(e=v(n,s));const l=n.hoverStyle||t.hoverStyle;l&&i.isHover(t,o)&&(e=v(n,l));const r=n.pressStyle||t.pressStyle;r&&i.isPress(t,o)&&(e=v(n,r))}return e?n:void 0}function b(t,e,n,s){const o=n?t:{},l=n||t;for(let t in l)s&&i.animateExcludes[t]||(o[t]=e[t]);return o}function p(t,e,n){return b(t,e,n,!0)}function v(t,e){return Object.assign(t,e),!0}function g(t,e){const n=t[e];n&&S(t,n),t.button&&k(t.children,e)}function _(t,e,n){n||(n=t.states[e]),S(t,n),t.button&&k(t.children,null,e)}function k(t,e,n){if(!t)return;let s,o;for(let l=0,r=t.length;l<r;l++){if(s=t[l],e){switch(o=!0,e){case"hoverStyle":i.isHover(s)&&(o=!1);break;case"pressStyle":i.isPress(s)&&(o=!1);break;case"focusStyle":i.isFocus(s)&&(o=!1)}o&&g(s,e)}else n&&_(s,n);s.isBranch&&k(s.children,e,n)}}function D(t,e){const n=t[e];n&&y(t,n),t.button&&O(t.children,e)}function E(t,e,n){y(t,n),t.button&&O(t.children,null,e)}function O(t,e,n){if(!t)return;let s;for(let i=0,o=t.length;i<o;i++)s=t[i],e?D(s,e):n&&E(s,n),s.isBranch&&O(s.children,e,n)}function w(t,e,n){let s;const i=e.leafer?e.leafer.interaction:null;if(i&&(s=i[t](e),!s&&n)){const o=f(e,n);o&&(s=i[t](o))}return s}function A(t,e,n){let s=e[t];if(!s&&n){const i=f(e,n);i&&(s=i[t])}return s}i.animateExcludes={animation:1,animationOut:1,transition:1,transitionOut:1,states:1,state:1,normalStyle:1,hoverStyle:1,pressStyle:1,focusStyle:1,selectedStyle:1,disabledStyle:1},i.isState=function(t,e,n){return function(t,e,n){let s=e.states[t];if(!s&&n){const i=f(e,n);i&&(s=i.states[t])}return!!s}(t,e,n)},i.isSelected=function(t,e){return A("selected",t,e)},i.isDisabled=function(t,e){return A("disabled",t,e)},i.isFocus=function(t,e){return w("isFocus",t,e)},i.isHover=function(t,e){return w("isHover",t,e)},i.isPress=function(t,e){return w("isPress",t,e)},i.isDrag=function(t,e){return w("isDrag",t,e)},i.setStyleName=function(t,e,n){n?_(t,e,t[e]):E(t,e,t[e])},i.set=function(t,e){const n=t.states[e];n?_(t,e,n):E(t,e,n)},i.getStyle=m,i.updateStyle=h,i.updateEventStyle=function(t,e){switch(e){case l.ENTER:g(t,"hoverStyle");break;case l.LEAVE:D(t,"hoverStyle");break;case l.DOWN:g(t,"pressStyle");break;case l.UP:D(t,"pressStyle")}};const P=r.prototype;c(!1,"selectedStyle")(P,"selected"),c(!1,"disabledStyle")(P,"disabled"),u({})(P,"states"),c("")(P,"state"),a()(P,"normalStyle"),u()(P,"hoverStyle"),u()(P,"pressStyle"),u()(P,"focusStyle"),u()(P,"selectedStyle"),u()(P,"disabledStyle"),a(!1)(P,"button"),P.focus=function(t=!0){this.waitLeafer((()=>{let{focusData:e}=this.app.interaction;t?(e&&e.focus(!1),e=this):e=null,this.app.interaction.focusData=e,t?g(this,"focusStyle"):D(this,"focusStyle")}))},P.updateState=function(){i.updateStyle(this,void 0,"in")};export{u as stateStyleType,c as stateType};
